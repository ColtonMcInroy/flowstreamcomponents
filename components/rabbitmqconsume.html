<script total>

	exports.id = 'rabbitmqconsume';
	exports.name = 'RabbitMQ Consume';
	exports.group = 'RabbitMQ';
	exports.icon = 'fa fa-envelope-o';
	exports.author = 'Total Avengers';
	exports.version = '1';
	exports.config = {};
	exports.inputs = [];
	exports.outputs = [{ id: 'output', name: 'Output' }];

	exports.npm = ['amqp-connection-manager'];

	exports.make = function(instance, config) {

		var amqp = require('amqp-connection-manager');
		var Manager, channelWrapper;

		instance.configure = function() {
			instance.status('Reconfiguring..');
			console.log('rabbitconsume--------reconfigure', instance.replace(config.queuename));

			if (!config.hostname || !config.queuename) // queue name is optional in some cases, not supported here
				return instance.status('Not configured');

			config.port = config.port || 5672;
			config.vhost = config.vhost || '/';
			if (config.vhost[0] !== '/')
				config.vhost = '/' + config.vhost;

			var credentials = '';
			if (config.username)
				credentials += config.username;
			if (config.password)
				credentials += ':' + config.password;
			if (credentials)
				credentials += '@';

			var conString = `${config.protocol}://${credentials}${config.hostname}:${config.port}${config.vhost}`;

			// Create a new connection manager
			Manager = amqp.connect([conString]);
			Manager.on('connect', function(){
				instance.status('Connected');
				console.log('Rabbit Consume Connected');
			});
			Manager.on('disconnect', function(e){
				instance.status('Disconnected');
				console.log('Rabbit Consume Disconnected', e);
			});
			Manager.on('error', function(e){
				instance.status('Error');
				console.log('Rabbit Consume Error', e);
			});

			// Ask the connection manager for a ChannelWrapper. Specify a setup function to
			// run every time we reconnect to the broker.
			channelWrapper = Manager.createChannel({
				setup: function (channel) {
					// `channel` here is a regular amqplib `ConfirmChannel`.
					// Note that `this` here is the channelWrapper instance.
					var qname = instance.replace(config.queuename);
					return Promise.all([
						channel.assertQueue(qname, { consumerTag: 'consumer-' + qname }),
						channel.consume(qname, function(msg) {
							if (msg !== null) {
								var data = {
									queuename: qname,
									payload: msg.content.toString(),
									msg: msg
								};
								instance.send('output', data);
								channel.ack(msg);
							}
						})
					]);
				},
			});
		};

		instance.close = function() {
			Manager.close();
		};

		instance.configure();
	};

</script>

<readme>

</readme>

<settings>
	<div class="padding">
		<div class="row">
			<div class="col-md-6">
				<div data---="input__?.hostname__placeholder:localhost;required:1" class="m">@(Hostname or IP address)</div>
			</div>
			<div class="col-md-6">
				<div data---="input__?.port__type:number;placeholder:5672__5672" class="m">@(Port) (default: 5672)</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-6">
				<div data---="input__?.protocol__dirsource:amqp|amqp,amqps|amqps__amqp" class="m">@(Protocol)</div>
			</div>
			<div class="col-md-6">
				<div data---="input__?.vhost__placeholder:/" class="m">@(Virtual host)</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-6">
				<div data---="input__?.queuename__required:1" class="m">@(Queue name)</div>
				<div class="help m">@(Supports variables): queue-{queueid} , the {queueid} will be overwritten by the value from variables</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-6">
				<div data---="input__?.username" class="m">@(Username)</div>
			</div>
			<div class="col-md-6">
				<div data---="input__?.password__type:password" class="m">@(Password)</div>
			</div>
		</div>
	</div>
</settings>

<style>
	.CLASS footer { padding: 10px; font-size: 12px; }
</style>

<script>

</script>

<body>
	<header>
		<i class="ICON"></i>NAME
	</header>
	<footer data-bind="!STATUS__text"></footer>
</body>